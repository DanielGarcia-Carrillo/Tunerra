{% extends "base.html" %}
{% load staticfiles %}
{% block navbar %}
    <ul class="nav pull-right">
        <li>
            <form class="navbar-search pull-left" action="{% url "search" %}" method="get">
                <input type="text" class="search-query" placeholder="Get Recommendations">
            </form>
        </li>
        <li><a href="/accounts/profile/{{ user.username }}">Profile</a></li>
        <li><a href="{% url "map" %}">Map</a></li>
        <li><a href="{% url "settings" %}">Settings</a><li>
        <li><a href="{% url "logout" %}">Logout</a></li>
    </ul>
{% endblock navbar %}

{%block content %}

    <div class = "row-fluid">
        <div class ="span2"></div>
        <div class ="span6">
            <div class = "hero-unit"><h2>Welcome back, {{user.username}}</h2></div>
            <div class="well post-box">
                  <form method="post" action="" id="profile-post-form" accept-charset="utf-8"> {% csrf_token %}
                      {{ post_form.non_field_errors }}
                      {{ post_form.title.errors }}
                      {{ post_form.title }}<br />
                      {{ post_form.artist.errors }}
                      {{ post_form.artist }}<br />
                      {{ post_form.body.errors }}
                      {{ post_form.body }}
                      <div class="form-actions">
                        <input type="submit" class="btn btn-primary" value="Submit Post">
                      </div>
                  </form>
            </div>
            <div class="well" id="posts">
                <ul class="media-heading">
                    {% for post in feed_posts %}
                    <li class="media feed-post">
                      <a class="pull-left" href="#">
                          <img class="media-object" src="{{ post.song.album.cover_art_url }}">
                      </a>
                      <div class="media-body">
                          <h4 class="media-heading">{{ post.song.title }} - {{ post.song.artist }} - {{ post.song.album.name }}</h4>
                          <p class="post-body">{{ post.body }}</p>
                          <p class="post-info"><input type="button" id="post-{{ post.pk }}" class="btn btn-small btn-like" value="{{ post.likes }}"></p>
                          {% if post.user.username != request.user.username %}
                              {{ post.user.username }}
                          {% endif %}
                      </div>
                    </li>
                    {% endfor %}
                </ul>

            </div>
        </div>
        <div class="span3">
          <div id="music-recs">
              {% for rec in music_recommendations %}
              {% endfor %}
          </div>
          <div id="follow-recs">
              {% for rec in follow_recommendations %}
              {% endfor %}
          </div>â„¢
        </div>
    </div>

    <script>
        $(".btn-like").click(function(event) {
            event.preventDefault();
            var $button = $(this);
            var $id = parseInt($button.attr("id").split("-")[1]);

            $.ajax({
                url: "/accounts/profile/{{ request.user.username }}/like",
                type: "post",
                data: {
                    "post_id": $id,
                    "like_username": "{{request.user.username}}",
                    "csrfmiddlewaretoken": "{{ csrf_token }}"
                },
                success: function(response) {
                    if (response === "unliked") {
                        $button.val(parseInt($button.attr("value"))-1)
                    } else if (response === "liked") {
                        $button.val(parseInt($button.attr("value"))+1)
                    }
                },
                error: function(response) {
                    alert("Something went wrong")
                }
            });

        });

        $("#profile-post-form").submit(function(event) {
            event.preventDefault();
            var $form = $(this);
            serializedData = $form.serialize();

            $.ajax({
                url: "/accounts/feed/{{ request.user.username }}",
                type: "post",
                data: serializedData,
                success: function(response) {
                    alert(response)
                }

            });
        });
    </script>
{% endblock content %}